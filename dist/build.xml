<!-- ANT build script for yfiles obfuscation           -->
<!-- The java based ANT tool is available from         -->
<!-- http://jakarta.apache.org/ant                     -->
           	
<project name="SysBio" default="usage" basedir=".">
	
	<!-- =================================================================== -->
	<!-- Help on usage                                                       -->
	<!-- =================================================================== -->
	<target name="usage" depends="init">
		<echo message=""/>
		<echo message=""/>
		<echo message=" ${appBaseJar} Build file"/>
		<echo message=" -------------------------------------------------------------"/>
		<echo message=""/>
		<echo message=" available targets are:"/>
		<echo message=""/>
		<echo message="   jar         --> generates unobfuscated ${appBaseJarRaw}.jar file"/>
		<echo message="   obfuscate   --> generates obfuscated signed ${appBaseJarWithGraph}.jar file"/>
		<echo message="   javadoc     --> generates javadoc for the SysBio framework"/>
		<echo message="   clean       --> cleans up the directory"/>
		<echo message=""/>
		<echo message=" See the comments inside the build.xml file for more details."/>
		<echo message=" -------------------------------------------------------------"/>
		<echo message=""/>
		<echo message=""/>
	</target>

  <!-- define some properties that are used throughout the tasks -->
  <target name="init">
  	<echo>
  	  PLESE MAKE SURE ALL PATHS ARE CORRECT AND DECIDE IF YOU WANT
  	  TO USE THE LIB-JARs OR REFERENCED PROJECTS.
  	</echo>
  	<tstamp /> <!-- set ${TODAY} and ${TSTAMP} -->
  		
    <!-- the base directory of the SysBio repository -->
    <property name="base" location=".."/>
  	
    <!-- the path to the SysBio sources -->
  	<property name="src" location="${base}/src"/>
  	
  	<!-- the version of the current release -->
  	<property name="version" value="1.2"/>
  	
  	<!-- path to examples folder -->
  	<property name="examples" location="${base}/examples"/>
  	
  	<!-- path to MacOSX support -->
  	<property name="mac_support" location="${base}/src_mac_api"/>
  	
  	<!-- the path to the SysBio sources -->
  	<property name="doc" location="${base}/doc/api"/>
  	
    <!-- the path to the SysBio binaries -->
    <property name="classes" location="${base}/bin"/>
    
    <!-- the path to the SysBio libraries -->
  	<property name="lib" location="${base}/lib"/>

    <!-- the application jar file basenames (without ".jar") -->
  	<!-- without graph package -->
    <property name="appBaseJar" value="SysBio"/>
    <!-- with graph package, unobfuscated -->
    <property name="appBaseJarRaw" value="SysBio_graph_unobfuscated"/>
    <!-- the FINAL obfuscated signed application jar -->
    <property name="appBaseJarWithGraph" value="SysBio_graph"/>

    <!-- the application jar file names -->
    <!-- without graph package -->
    <property name="appJar" value="${appBaseJar}.jar"/>
    <!-- with graph package, unobfuscated -->
    <property name="appJarRaw" value="${appBaseJarRaw}.jar"/>
    <!-- the FINAL obfuscated signed application jar file -->
    <property name="appJarWithGraph" value="${appBaseJarWithGraph}.jar"/>
  	
    <!-- the yGuard jar file containing the obfuscation task -->
    <property name="yGuardJar" value="yguard.jar"/>
    
    <!-- the log file geenrated by the obfuscation task -->
    <property name="obfuscationLog" value="obfuscation-log.xml"/>
  	
  </target>

  <!-- puts the application specific classes into application.jar. -->
  <target name="jar" depends="init">
    <delete file="${appJar}"/>
    <jar jarfile="${appJar}">
      <manifest>
        <!-- TODO: An auto-generated About dialog as main class would be nice -->
        <!-- <attribute name="Main-Class" value="org.sbml.simulator.SysBio"/> -->
        <attribute name="Built-By" value="Center for Bioinformatics Tuebingen (ZBIT)"/>
      </manifest>
    	
    	<!-- SysBio Classes -->
          <fileset dir="${classes}">
              <!-- TODO: Please uncomment the following lines, to meet your needs! -->
    	      <!-- <exclude name="de/zbit/resources/**/*"/> -->
    	      <!-- <exclude name="de/zbit/mapper/**/*"/> -->
    	      <!-- <exclude name="de/zbit/gui/**/*"/> -->
    	      <exclude name="de/zbit/graph/**/*"/>
    	      <exclude name="**/package.html"/>
    	      <exclude name="overview.html"/>
    	    </fileset>
    	  <!-- These libraries are required by most classes -->
          <zipfileset excludes="META-INF/*" src="${lib}/commons-discovery.jar"/>
          <zipfileset excludes="META-INF/*" src="${lib}/commons-logging.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${lib}/jaxrpc.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${lib}/wsdl4j.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${lib}/axis.jar"/>
          <zipfileset excludes="META-INF/*" src="${lib}/commons-cli-1.1.jar"/>
          <zipfileset excludes="META-INF/*" src="${lib}/quaqua.jar"/>
          <zipfileset excludes="META-INF/*" src="${lib}/sysbio-osx-support.jar"/>
          
          <!-- These libraries are required by just some classes (decide yourself if you want them) -->
          <zipfileset excludes="META-INF/*.SF" src="${lib}/Java5/saaj.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${lib}/WSDbfetch.jar"/>
    </jar>
    
    
    <!-- JAR including the yFiles, zbit-graph and SBGN packages -->
    <delete file="${appJarRaw}"/>
    <jar jarfile="${appJarRaw}">
    	<!-- SysBio Classes -->
        <fileset dir="${classes}">
    	    <include name="de/zbit/graph/**/*"/>
    	  </fileset>
        <zipfileset excludes="META-INF/*" src="${lib}/graph/y.jar"/>
    	  <zipfileset excludes="META-INF/*" src="${lib}/graph/org.sbgn.jar"/>
        <zipfileset src="${appJar}"/>
    </jar>
  </target>


  <!-- obfuscates y.jar and adjusts application.jar accordingly. -->
  <!-- Generates the jar files yObf.jar and applicationObf.jar.  -->
  <target name="obfuscate" depends="jar">
    <taskdef name="yguard" classname="com.yworks.yguard.YGuardTask" classpath="${yGuardJar}"/>
    <yguard>
    	
      <!-- obfuscate yFiles for public deployment -->
      <inoutpair in="${appJarRaw}" out="${appJarWithGraph}"/>

      <!-- [OPTIONALLY] Keep the line number table and the source file attributes
                 of the public part of the "application" -->
      <attribute name="LineNumberTable,LocalVariableTable,SourceFile">
        <patternset>
          <include name="de.zbit.**"/>
        </patternset>
      </attribute>

      <rename logfile="${obfuscationLog}" replaceClassNameStrings="true" mainclass="${main}">
        <!-- conservemanifest="true" -->
        <!-- use some unique package prefix for obfuscated classes to avoid name clashes -->
        <property name="obfuscation-prefix" value="obfuscatedintegrator"/>


        <keep>
          <package>
            <patternset>
              <include name="de.**.*"/>
            </patternset>
          </package>

          
             <!-- Keep all method, field, and class names of the "application"             -->
             <!-- This could be adjusted to your needs if you don't want to let            -->
             <!-- your whole application unobfuscated.                                     -->
             <!-- In that case simply add some more "exclude" statements as depicted below -->
             <class classes="private" methods="private" fields="private">
              <patternset>
                <!-- Do not obfuscate anything, by default -->
               <include name="**.*"/>

                <!-- Obfuscate all classes that make use of y.jar -->
              	<!-- We can NOT obfuscate de.zbit.graph.**.*, because there are some resources (labels) in there -->
                <exclude name="de.zbit.graph.*"/>
              	<exclude name="de.zbit.graph.gui.**.*"/>
                <exclude name="de.zbit.graph.io.**.*"/>
              	<exclude name="de.zbit.graph.sbgn.**.*"/>
              	

               <!-- Obfuscate the included y.jar -->
               <exclude name="y.**.*"/>
              </patternset>
             </class>
            
        </keep>

        <!-- make sure that the .properties files are renamed according to their               -->
        <!-- corresponding class files, yFiles needs this to function properly when obfuscated -->
        <adjust replaceName="true">
          <include name="y/**/*.properties"/>
        </adjust>
      </rename>
    </yguard>
  	<delete file="${appJarRaw}"/>
  </target>

  <!-- Removes all that has been built -->
  <target name="clean" depends="init">
  	<delete file="${appJarRaw}"/>
  	<delete file="${appJarWithGraph}"/>
    <delete file="${appJar}"/>
    <delete includeemptydirs="true" dir="${classes}"/>
  </target>


  <target
  	name="javadoc"
  	depends="init"
  	description="Creates Javadoc for the SysBio Framework">
  	
  	<mkdir dir="${doc}"/>
  	<mkdir dir="${doc}/version_${version}"/>
	<path id="classpath">
      <fileset dir="${lib}" includes="**.jar, **.zip"/>
    </path>
  	<!-- ${lib}/junit-4.3.1.jar:${lib}/jsbml-1.0-a1-with-dependencies.jar:${lib}/jaxrpc.jar:${lib}/axis.jar:${lib}/commons-cli-1.1.jar:${lib}/commons-discovery.jar:${lib}/commons-logging.jar:${lib}/jaxrpc.jar:${lib}/keggapi.jar:${lib}/WSDbfetch.jar:${lib}/wsdl4j.jar:${lib}/quaqua.jar:${lib}/graph/org.sbgn.jar:${lib}/graph/y.jar:${lib}/garuda/garuda-csr.jar:${lib}/garuda/jsonic-1.2.10.jar:${lib}/garuda/log4j-1.2.16.jar -->
	<javadoc
      sourcepath="${src}:${test}:${resources}:${examples}:${mac_support}"
      destdir="${doc}/version_${version}"
      packagenames="de.zbit.*"
      footer="Generated ${TODAY}"
      access="protected"
      author="true"
      doctitle="SysBio Library ${version}"
      nodeprecated="false"
      nodeprecatedlist="false"
      noindex="false"
      nonavbar="false"
      notree="false"
      source="1.6"
      splitindex="true"
      use="true"
      stylesheetfile="${doc}/javadoc-style.css" 
      overview="${src}/overview.html"
      classpathref="classpath"
      version="true">
		<link href="http://commons.apache.org/io/api-1.4/"/>
		<link href="http://commons.apache.org/math/api-2.2/"/>
		<link href="http://download.oracle.com/javase/6/docs/api/"/>
		<link href="http://javasourcecode.org/html/open-source/junit/junit-4.8/"/>
		<link href="http://jaxen.codehaus.org/apidocs/"/>
		<link href="http://sbml.org/Special/Software/JSBML/latest-stable/build/apidocs/"/>
		<link href="http://www.jdom.org/docs/apidocs.1.1/"/>
		<link href="http://www.xom.nu/apidocs/"/>
		<link href="http://docs.yworks.com/yfiles/doc/api/"/>
    </javadoc>
  	
  </target>
	
	<target name="svnrevision" depends="init">
	    <exec executable="svnversion" outputproperty="repository.revision">
	        <arg line="-c ${base}" />
	        <redirector>
	            <outputfilterchain>
	                <tokenfilter>
	                    <replaceregex pattern="[0-9]+\:" replace="" />
	                    <replaceregex pattern="[PM]+" replace="" />
	                </tokenfilter>
	            </outputfilterchain>
	        </redirector>
	    </exec>
      <echo message="Current revision is ${repository.revision}" />

    <property name="appJarRev" value="${appBaseJar}_r${repository.revision}.jar"/>
    <property name="appJarRevRaw" value="${appBaseJarRaw}_r${repository.revision}.jar"/>
    <property name="appJarRevWithGraph" value="${appBaseJarWithGraph}_r${repository.revision}.jar"/>
	</target>
	
	<target name="jar_revision_number" depends="obfuscate,svnrevision" description="Renames the JAR revision number to its filename">
    <!-- the FINAL obfuscated signed application jar files -->

		<!--
		<delete file="${appJarRev}"/>
    <delete file="${appJarRevRaw}"/>
    <delete file="${appJarRevWithGraph}"/>
    -->
    	
		<move failonerror="false" tofile="${appJarRev}" file="${appJar}"/>
    <move failonerror="false" tofile="${appJarRevRaw}" file="${appJarRaw}"/>
    <move failonerror="false" tofile="${appJarRevWithGraph}" file="${appJarWithGraph}"/>
  </target>
		
	
</project>